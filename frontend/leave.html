<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Management - MRIT Hub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 1rem; text-align: center; }
        .nav { background: #34495e; padding: 0.5rem; display: flex; justify-content: center; gap: 1rem; }
        .nav button { background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .nav button:hover { background: #2980b9; }
        .nav button.active { background: #e74c3c; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .balance-card { background: #ecf0f1; padding: 1rem; border-radius: 4px; text-align: center; }
        .status-pending, .status-pending-substitute, .status-pending-hod { color: #f39c12; font-weight: bold; }
        .status-approved { color: #27ae60; font-weight: bold; }
        .status-rejected { color: #e74c3c; font-weight: bold; }
        .status-cancelled { color: #95a5a6; font-weight: bold; }
        .hidden { display: none; }
        .mandatory { color: red; }
        .loading { color: #3498db; font-style: italic; }
        .error { color: #e74c3c; background: #fdf2f2; padding: 1rem; border-radius: 4px; margin: 1rem 0; }
        .success { color: #27ae60; background: #f0f9f4; padding: 1rem; border-radius: 4px; margin: 1rem 0; }
        .form-group input:invalid, .form-group select:invalid, .form-group textarea:invalid {
            border-color: #e74c3c;
        }
        .form-group input:valid, .form-group select:valid, .form-group textarea:valid {
            border-color: #27ae60;
        }
        .balance-card h4 { margin-bottom: 0.5rem; color: #2c3e50; }
        .balance-card p { margin: 0.25rem 0; }
        .demo-notice { background: #fff3cd; color: #856404; padding: 0.75rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #ffc107; }
        .demo-notice strong { color: #664d03; }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 1rem; margin-top: 1rem; }
            .header { padding: 1rem; position: relative; }
            .header h1 { font-size: 1.25rem; }
            .header > div { position: static !important; margin-top: 0.75rem; display: flex; gap: 0.5rem; justify-content: center; }
            .header button { margin: 0 !important; padding: 0.5rem 1rem; font-size: 0.9rem; }
            
            .nav { flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; }
            .nav button { flex: 1 1 calc(50% - 0.5rem); font-size: 0.85rem; padding: 0.5rem; }
            
            .card { padding: 1rem; }
            .form-group label { font-size: 0.9rem; }
            .form-group input, .form-group select, .form-group textarea { 
                font-size: 1rem;
                padding: 0.75rem;
                min-height: 44px;
            }
            
            /* Larger dropdown options for Android */
            select option {
                font-size: 16px;
                padding: 12px 8px;
                line-height: 1.5;
            }
            
            /* Disable native dropdown on mobile */
            .mobile-picker-trigger {
                pointer-events: none;
                -webkit-appearance: none;
                appearance: none;
            }
            
            .balance-grid { grid-template-columns: 1fr; }
            .balance-card { padding: 0.75rem; }
            
            .btn { padding: 0.75rem 1rem; font-size: 1rem; min-height: 44px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 1rem; }
            .nav button { flex: 1 1 100%; }
            .balance-card h4 { font-size: 0.9rem; }
        }
        
        /* Modal Picker for Mobile */
        .modal-picker {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        .modal-picker.active { display: flex; align-items: flex-end; }
        
        .modal-content {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 20px 20px 0 0;
            animation: slideUp 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
            color: #1f2937;
        }
        
        .modal-close {
            background: #f3f4f6;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-search {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
        }
        
        .modal-options {
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-option {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.2s;
        }
        
        .modal-option:active {
            background: #f3f4f6;
        }
        
        .modal-option.selected {
            background: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è MRIT Hub - Leave Management System</h1>
        <div style="position: absolute; top: 1rem; right: 1rem;">
            <button class="btn" onclick="window.location.href='dashboard.html'" style="background: #34495e; margin-right: 0.5rem;">‚Üê Dashboard</button>
            <button class="btn" onclick="logout()" style="background: #e74c3c;">Logout</button>
        </div>
    </div>

    <div class="nav">
        <button onclick="showSection('apply')" id="btn-apply">APPLY</button>
        <button onclick="showSection('view')" id="btn-view">VIEW</button>
        <button onclick="showSection('balance')" id="btn-balance">BALANCE</button>
        <button onclick="showSection('approve')" id="btn-approve">APPROVE LEAVES</button>
    </div>

    <div class="container">
        <!-- Apply Leave Section -->
        <div id="section-apply" class="card">
            <h2>Apply for Leave</h2>
            <p>Fields marked with <span class="mandatory">*</span> are mandatory</p>
            <form id="apply-form">
                <div class="form-group">
                    <label>Leave Type <span class="mandatory">*</span></label>
                    <select id="leave-type" class="mobile-picker-trigger" required>
                        <option value="">Select Leave Type</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>From Date <span class="mandatory">*</span></label>
                    <input type="date" id="from-date" required>
                </div>
                <div class="form-group">
                    <label>To Date <span class="mandatory">*</span></label>
                    <input type="date" id="to-date" required>
                </div>
                <div class="form-group">
                    <label>Total Days <span class="mandatory">*</span></label>
                    <input type="number" id="total-days" step="0.5" min="0.5" required readonly>
                </div>
                <div class="form-group">
                    <label>Reason <span class="mandatory">*</span></label>
                    <textarea id="reason" rows="3" required></textarea>
                </div>
                <div class="form-group" id="substitute-group">
                    <label>Substitute Teacher</label>
                    <select id="substitute-teacher" class="mobile-picker-trigger">
                        <option value="">Select Substitute</option>
                    </select>
                </div>
                <button type="submit" class="btn">Submit Application</button>
            </form>
        </div>

        <!-- View Applications Section -->
        <div id="section-view" class="card hidden">
            <h2>My Leave Applications</h2>
            <div id="applications-list"></div>
        </div>

        <!-- Balance Section -->
        <div id="section-balance" class="card hidden">
            <h2>Leave Balance</h2>
            <div id="balance-grid" class="balance-grid"></div>
        </div>

        <!-- Approve Leaves Section -->
        <div id="section-approve" class="card hidden">
            <h2>Approve Leaves</h2>
            <div class="nav" style="background: #ecf0f1; margin-bottom: 1rem;">
                <button onclick="showApprovals('substitute')" id="btn-sub-approvals">SUBSTITUTE APPROVALS</button>
                <button onclick="showApprovals('hod')" id="btn-hod-approvals">HOD APPROVALS</button>
            </div>
            <div id="substitute-approvals"></div>
            <div id="hod-approvals" class="hidden"></div>
        </div>
    </div>

    <!-- Modal Picker -->
    <div id="modalPicker" class="modal-picker">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Select Option</h3>
                <button class="modal-close" onclick="closeModalPicker()">&times;</button>
            </div>
            <div class="modal-search">
                <input type="text" id="modalSearch" placeholder="Search..." oninput="filterModalOptions()">
            </div>
            <div class="modal-options" id="modalOptions"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let authToken = localStorage.getItem('accessToken');
        let currentSelectId = null;
        let isMobile = window.innerWidth <= 768;
        
        // Check authentication
        if (!authToken) {
            window.location.href = 'index.html';
        }
        
        // Mobile picker setup
        if (isMobile) {
            document.querySelectorAll('.mobile-picker-trigger').forEach(select => {
                select.style.pointerEvents = 'auto';
                select.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        e.stopPropagation();
                        openModalPicker(this);
                        return false;
                    }
                });
                select.addEventListener('mousedown', function(e) {
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        return false;
                    }
                });
            });
        }
        
        function openModalPicker(selectElement) {
            if (window.innerWidth > 768) return;
            
            currentSelectId = selectElement.id;
            const label = selectElement.previousElementSibling.textContent.replace('*', '').trim();
            const options = Array.from(selectElement.options);
            const currentValue = selectElement.value;
            
            document.getElementById('modalTitle').textContent = `Select ${label}`;
            document.getElementById('modalSearch').value = '';
            
            const modalOptions = document.getElementById('modalOptions');
            modalOptions.innerHTML = options.map(opt => `
                <div class="modal-option ${opt.value === currentValue ? 'selected' : ''}" 
                     data-value="${opt.value}" 
                     onclick="selectModalOption('${opt.value.replace(/'/g, "\\'")}')">  
                    ${opt.text}
                </div>
            `).join('');
            
            document.getElementById('modalPicker').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModalPicker() {
            document.getElementById('modalPicker').classList.remove('active');
            document.body.style.overflow = '';
            currentSelectId = null;
        }
        
        function selectModalOption(value) {
            if (currentSelectId) {
                const select = document.getElementById(currentSelectId);
                select.value = value;
                
                // Trigger change event
                const event = new Event('change', { bubbles: true });
                select.dispatchEvent(event);
            }
            closeModalPicker();
        }
        
        function filterModalOptions() {
            const searchTerm = document.getElementById('modalSearch').value.toLowerCase();
            const options = document.querySelectorAll('.modal-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }
        
        // Close modal on backdrop click
        document.getElementById('modalPicker').addEventListener('click', function(e) {
            if (e.target === this) closeModalPicker();
        });
        
        // Update isMobile on resize
        window.addEventListener('resize', () => {
            isMobile = window.innerWidth <= 768;
        });
        
        // Helper function to make authenticated requests
        async function makeAuthenticatedRequest(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            const response = await fetch(url, { ...options, headers });
            
            if (response.status === 401) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = 'index.html';
                return;
            }
            
            return response;
        }

        // Show/hide sections
        function showSection(section) {
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="btn-"]').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`section-${section}`).classList.remove('hidden');
            document.getElementById(`btn-${section}`).classList.add('active');

            if (section === 'apply') loadLeaveTypes();
            if (section === 'view') loadMyApplications();
            if (section === 'balance') loadLeaveBalances();
            if (section === 'approve') loadPendingApprovals();
        }

        function showApprovals(type) {
            document.getElementById('substitute-approvals').classList.toggle('hidden', type !== 'substitute');
            document.getElementById('hod-approvals').classList.toggle('hidden', type !== 'hod');
            document.getElementById('btn-sub-approvals').classList.toggle('active', type === 'substitute');
            document.getElementById('btn-hod-approvals').classList.toggle('active', type === 'hod');
        }

        // Calculate total days
        function calculateDays() {
            const fromDate = new Date(document.getElementById('from-date').value);
            const toDate = new Date(document.getElementById('to-date').value);
            
            if (fromDate && toDate && fromDate <= toDate) {
                const diffTime = Math.abs(toDate - fromDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('total-days').value = diffDays;
                
                // Check if exceeds max days for selected leave type
                const leaveTypeSelect = document.getElementById('leave-type');
                const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
                const maxDays = selectedOption ? selectedOption.dataset.maxDays : null;
                
                if (maxDays && diffDays > parseInt(maxDays)) {
                    const warning = document.getElementById('days-warning') || document.createElement('div');
                    warning.id = 'days-warning';
                    warning.style.cssText = 'color: #e74c3c; font-size: 0.9em; margin-top: 0.25rem;';
                    warning.textContent = `Warning: ${diffDays} days exceeds maximum allowed (${maxDays} days/year)`;
                    
                    const totalDaysInput = document.getElementById('total-days');
                    if (!document.getElementById('days-warning')) {
                        totalDaysInput.parentNode.appendChild(warning);
                    }
                } else {
                    const warning = document.getElementById('days-warning');
                    if (warning) warning.remove();
                }
            } else {
                document.getElementById('total-days').value = '';
                const warning = document.getElementById('days-warning');
                if (warning) warning.remove();
            }
        }

        // Load leave types
        async function loadLeaveTypes() {
            const select = document.getElementById('leave-type');
            select.innerHTML = '<option value="">Loading...</option>';
            
            try {
                const response = await fetch(`${API_BASE}/leave/types`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const types = await response.json();
                
                select.innerHTML = '<option value="">Select Leave Type</option>';
                if (Array.isArray(types) && types.length > 0) {
                    types.forEach(type => {
                        const maxDays = type.max_days_per_year ? ` (Max: ${type.max_days_per_year}/year)` : '';
                        const halfDay = type.allow_half_day ? ' (Half-day allowed)' : '';
                        select.innerHTML += `<option value="${type.id}" data-substitute="${type.requires_substitute}" data-max-days="${type.max_days_per_year}">${type.name}${maxDays}${halfDay}</option>`;
                    });
                } else {
                    select.innerHTML = '<option value="">No leave types available</option>';
                }
                
                // Load substitute faculty list
                loadSubstituteFaculty();
            } catch (error) {
                console.error('Error loading leave types:', error);
                select.innerHTML = '<option value="">Error loading types</option>';
            }
        }

        // Load applications
        async function loadMyApplications() {
            const container = document.getElementById('applications-list');
            container.innerHTML = '<div class="card">Loading applications...</div>';
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/my-applications`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const applications = await response.json();
                
                if (Array.isArray(applications) && applications.length > 0) {
                    container.innerHTML = applications.map(app => `
                        <div class="card" style="margin-bottom: 1rem; border-left: 4px solid ${getStatusColor(app.status)};">
                            <h4>${app.leave_type?.name || 'Unknown Leave Type'}</h4>
                            <p><strong>Dates:</strong> ${formatDate(app.from_date)} to ${formatDate(app.to_date)} (${app.total_days} days)</p>
                            <p><strong>Reason:</strong> ${app.reason}</p>
                            <p><strong>Status:</strong> <span class="status-${app.status.toLowerCase().replace(/_/g, '-')}">${formatStatus(app.status)}</span></p>
                            <p><strong>Applied:</strong> ${formatDate(app.created_at)}</p>
                            ${app.substitute_faculty ? `<p><strong>Substitute:</strong> ${app.substitute_faculty.faculty_name}</p>` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="card">No leave applications found.</div>';
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                container.innerHTML = '<div class="card" style="color: red;">Error loading applications. Please try again.</div>';
            }
        }

        // Load balances
        async function loadLeaveBalances() {
            const container = document.getElementById('balance-grid');
            container.innerHTML = '<div class="balance-card">Loading balances...</div>';
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/balance`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const balances = await response.json();
                
                if (Array.isArray(balances) && balances.length > 0) {
                    container.innerHTML = balances.map(balance => {
                        const percentage = balance.opening_balance > 0 ? 
                            ((balance.remaining_days / balance.opening_balance) * 100).toFixed(1) : 0;
                        return `
                            <div class="balance-card" style="border-left: 4px solid ${getBalanceColor(percentage)};">
                                <h4>${balance.leave_type?.name || 'Unknown Type'}</h4>
                                <p><strong>Used:</strong> ${balance.used_days || 0} days</p>
                                <p><strong>Remaining:</strong> ${balance.remaining_days || 0} days</p>
                                <p><strong>Total:</strong> ${balance.opening_balance || 0} days</p>
                                <p><strong>Available:</strong> ${percentage}%</p>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="balance-card">No leave balances configured for this academic year.</div>';
                }
            } catch (error) {
                console.error('Error loading balances:', error);
                container.innerHTML = '<div class="balance-card" style="color: red;">Error loading balances.</div>';
            }
        }

        // Load substitute faculty
        async function loadSubstituteFaculty() {
            const select = document.getElementById('substitute-teacher');
            select.innerHTML = '<option value="">Loading faculty...</option>';
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/faculty-list`);
                
                if (response.ok) {
                    const faculty = await response.json();
                    
                    select.innerHTML = '<option value="">Select Substitute</option>';
                    if (Array.isArray(faculty) && faculty.length > 0) {
                        faculty.forEach(f => {
                            const name = f.faculty_name || f.name;
                            const dept = f.department?.name || f.department || '';
                            const deptText = dept ? ` (${dept})` : '';
                            select.innerHTML += `<option value="${f.id}">${name}${deptText}</option>`;
                        });
                    } else {
                        select.innerHTML = '<option value="">No faculty available</option>';
                    }
                } else {
                    select.innerHTML = '<option value="">Error loading faculty</option>';
                }
            } catch (error) {
                console.error('Error loading faculty:', error);
                select.innerHTML = '<option value="">Error loading faculty</option>';
            }
        }

        // Load pending approvals
        async function loadPendingApprovals() {
            loadSubstituteApprovals();
            loadHodApprovals();
        }
        
        async function loadSubstituteApprovals() {
            const container = document.getElementById('substitute-approvals');
            container.innerHTML = '<div class="card">Loading substitute approvals...</div>';
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/pending-approvals/substitute`);
                
                if (response.ok) {
                    const approvals = await response.json();
                    
                    if (Array.isArray(approvals) && approvals.length > 0) {
                        container.innerHTML = approvals.map(app => `
                            <div class="card" style="margin-bottom: 1rem; border-left: 4px solid #f39c12;">
                                <h4>${app.leave_type?.name || 'Unknown Leave Type'} - ${app.faculty?.faculty_name || 'Unknown Faculty'}</h4>
                                <p><strong>Dates:</strong> ${formatDate(app.from_date)} to ${formatDate(app.to_date)} (${app.total_days} days)</p>
                                <p><strong>Reason:</strong> ${app.reason}</p>
                                <p><strong>Applied:</strong> ${formatDate(app.created_at)}</p>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-success" style="margin-right: 0.5rem;" onclick="approveLeave(${app.id}, 'substitute', true)">Approve</button>
                                    <button class="btn btn-danger" onclick="approveLeave(${app.id}, 'substitute', false)">Reject</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="card">No pending substitute approvals.</div>';
                    }
                } else {
                    container.innerHTML = '<div class="card" style="color: red;">Error loading substitute approvals.</div>';
                }
            } catch (error) {
                console.error('Error loading substitute approvals:', error);
                container.innerHTML = '<div class="card" style="color: red;">Error loading substitute approvals.</div>';
            }
        }
        
        async function loadHodApprovals() {
            const container = document.getElementById('hod-approvals');
            container.innerHTML = '<div class="card">Loading HOD approvals...</div>';
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/pending-approvals/hod`);
                
                if (response.ok) {
                    const approvals = await response.json();
                    
                    if (Array.isArray(approvals) && approvals.length > 0) {
                        container.innerHTML = approvals.map(app => `
                            <div class="card" style="margin-bottom: 1rem; border-left: 4px solid #3498db;">
                                <h4>${app.leave_type?.name || 'Unknown Leave Type'} - ${app.faculty?.faculty_name || 'Unknown Faculty'}</h4>
                                <p><strong>Dates:</strong> ${formatDate(app.from_date)} to ${formatDate(app.to_date)} (${app.total_days} days)</p>
                                <p><strong>Reason:</strong> ${app.reason}</p>
                                <p><strong>Substitute Status:</strong> <span style="color: #27ae60;">Approved</span></p>
                                <p><strong>Applied:</strong> ${formatDate(app.created_at)}</p>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-success" style="margin-right: 0.5rem;" onclick="approveLeave(${app.id}, 'hod', true)">Approve</button>
                                    <button class="btn btn-danger" onclick="approveLeave(${app.id}, 'hod', false)">Reject</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="card">No pending HOD approvals.</div>';
                    }
                } else {
                    container.innerHTML = '<div class="card" style="color: red;">Error loading HOD approvals.</div>';
                }
            } catch (error) {
                console.error('Error loading HOD approvals:', error);
                container.innerHTML = '<div class="card" style="color: red;">Error loading HOD approvals.</div>';
            }
        }
        
        // Approve/reject leave function
        async function approveLeave(applicationId, stage, isApproved) {
            const action = isApproved ? 'approve' : 'reject';
            const reason = isApproved ? '' : prompt('Please provide reason for rejection:');
            
            if (!isApproved && !reason) {
                return; // User cancelled
            }
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/approve/${applicationId}/${stage}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        decision: isApproved ? 'APPROVED' : 'REJECTED',
                        comment: reason || ''
                    })
                });
                
                if (response.ok) {
                    alert(`Leave application ${action}d successfully!`);
                    // Reload the appropriate approvals
                    if (stage === 'substitute') {
                        loadSubstituteApprovals();
                        // Also reload applications if viewing own applications
                        if (document.getElementById('section-view').style.display !== 'none') {
                            loadMyApplications();
                        }
                    } else {
                        loadHodApprovals();
                        // Also reload applications if viewing own applications  
                        if (document.getElementById('section-view').style.display !== 'none') {
                            loadMyApplications();
                        }
                    }
                } else {
                    const error = await response.json();
                    alert(`Error ${action}ing leave: ${error.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error(`Error ${action}ing leave:`, error);
                alert(`Error ${action}ing leave. Please try again.`);
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-IN');
        }

        function formatStatus(status) {
            return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getStatusColor(status) {
            switch(status) {
                case 'APPROVED': return '#27ae60';
                case 'REJECTED': return '#e74c3c';
                case 'PENDING_SUBSTITUTE': return '#f39c12';
                case 'PENDING_HOD': return '#3498db';
                default: return '#95a5a6';
            }
        }

        function getBalanceColor(percentage) {
            if (percentage >= 70) return '#27ae60';
            if (percentage >= 30) return '#f39c12';
            return '#e74c3c';
        }

        function showDemoNotice(message) {
            // Remove existing demo notice
            const existing = document.querySelector('.demo-notice');
            if (existing) existing.remove();
            
            // Create demo notice
            const notice = document.createElement('div');
            notice.className = 'demo-notice';
            notice.style.cssText = 'background: #fff3cd; color: #856404; padding: 0.75rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #ffc107;';
            notice.innerHTML = `<strong>Demo Mode:</strong> ${message}`;
            
            // Add to container
            const container = document.querySelector('.container');
            container.insertBefore(notice, container.firstChild);
            
            // Auto-remove after 10 seconds
            setTimeout(() => notice.remove(), 10000);
        }

        // Event listeners
        document.getElementById('from-date').addEventListener('change', calculateDays);
        document.getElementById('to-date').addEventListener('change', calculateDays);

        document.getElementById('leave-type').addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            const requiresSubstitute = selected.dataset.substitute === 'true';
            document.getElementById('substitute-group').style.display = requiresSubstitute ? 'block' : 'none';
            
            // Recalculate days to show warning if needed
            calculateDays();
        });

        document.getElementById('apply-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form
            const leaveTypeId = document.getElementById('leave-type').value;
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            const totalDays = document.getElementById('total-days').value;
            const reason = document.getElementById('reason').value.trim();
            const substituteId = document.getElementById('substitute-teacher').value;
            
            if (!leaveTypeId || !fromDate || !toDate || !totalDays || !reason) {
                alert('Please fill all required fields');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                alert('From date cannot be after to date');
                return;
            }
            
            const formData = {
                leave_type_id: parseInt(leaveTypeId),
                from_date: fromDate,
                to_date: toDate,
                total_days: parseFloat(totalDays),
                reason: reason,
                substitute_faculty_id: substituteId ? parseInt(substituteId) : null
            };

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;
            
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/leave/apply`, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.innerHTML = `<strong>Success!</strong> Leave application submitted successfully. Application ID: ${result.id || 'N/A'}`;
                    this.insertBefore(successDiv, this.firstChild);
                    
                    // Reset form
                    this.reset();
                    document.getElementById('substitute-group').style.display = 'none';
                    const warning = document.getElementById('days-warning');
                    if (warning) warning.remove();
                    
                    // Remove success message after 7 seconds
                    setTimeout(() => successDiv.remove(), 7000);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to submit application');
                }
            } catch (error) {
                console.error('Error submitting application:', error);
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Error: ' + error.message;
                this.insertBefore(errorDiv, this.firstChild);
                
                setTimeout(() => errorDiv.remove(), 5000);
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Initialize
        showSection('apply');
        document.getElementById('btn-apply').classList.add('active');
        
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>